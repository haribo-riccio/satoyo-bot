# 円建SP500投信 通知システム リニューアル計画

## 概要

GASからGitHub Actions + Node.jsに移行し、データソースの安定化と共同メンテナンス体制を構築する。

## 現状の課題

- 取得先（nikkeiyosoku.com, murc-kawasesouba.jp）が不安定
- 祝日判定がない
- GASは共同メンテナンスしづらい
- コードがGoogleアカウントに紐づいている

## 新アーキテクチャ

```
GitHub Actions (cron: 毎朝9時)
    │
    ├─→ 祝日チェック（日本・米国）
    │
    ├─→ S&P500取得（Yahoo Finance）
    │
    ├─→ TTM取得（外為オンライン）
    │
    ├─→ 計算 & Discord通知
    │
    └─→ data.json更新 & コミット
```

---

## ファイル構成

```
sp500-notify/
├── .github/
│   └── workflows/
│       └── notify.yml      # GitHub Actions定義
├── src/
│   ├── index.js            # メイン処理
│   ├── fetchSP500.js       # S&P500取得
│   ├── fetchTTM.js         # TTM取得
│   ├── checkHoliday.js     # 祝日判定
│   └── sendDiscord.js      # Discord通知
├── data.json               # データ保持
├── package.json
└── README.md
```

---

## データソース

### S&P500 終値

| 項目 | 内容 |
|------|------|
| ソース | Yahoo Finance Japan |
| URL | `https://finance.yahoo.co.jp/quote/%5EGSPC` |
| 方式 | HTMLスクレイピング（cheerio使用） |
| 認証 | 不要 |

### 為替レート（TTS/TTB）

| 項目 | 内容 |
|------|------|
| ソース | 外為オンライン |
| URL | `http://www.gaitameonline.com/rateaj/getrate` |
| 方式 | JSON API |
| 認証 | 不要 |

### 日本祝日

| 項目 | 内容 |
|------|------|
| ソース | Holidays JP API |
| URL | `https://holidays-jp.github.io/api/v1/{year}/date.json` |
| 方式 | JSON API |
| 認証 | 不要 |

### 米国休場日

| 項目 | 内容 |
|------|------|
| 方式 | コード内に静的リストとして定義 |
| 更新頻度 | 年1回 |

---

## data.json 構造

```json
{
  "yearStart": {
    "date": "2025-01-02",
    "sp500": 5881.63,
    "ttm": 157.31
  },
  "previous": {
    "date": "2025-12-23",
    "sp500": 6834.5,
    "ttm": 157.62
  },
  "current": {
    "date": "2025-12-24",
    "sp500": 6909.79,
    "ttm": 157.38
  }
}
```

---

## 計算ロジック

```javascript
const ttm = (tts + ttb) / 2;
const dailyChange = (current.sp500 * current.ttm) / (previous.sp500 * previous.ttm) - 1;
const ytdChange = (current.sp500 * current.ttm) / (yearStart.sp500 * yearStart.ttm) - 1;
```

---

## Discord出力フォーマット

### 通常時
```
【円建SP500投信 速報（理論値）】
前日比：2.03%
年始からの損益：14.93%

前々日 SP500終値：6774.76
前日TTM：155.85

前日SP500終値：6834.5
本日TTM：157.62
```

### 休場日
```
【円建SP500投信】
本日は米国市場休場日のためお休みです
```

---

## GitHub Actions設定

```yaml
# .github/workflows/notify.yml
name: SP500 Notify

on:
  schedule:
    - cron: '0 0 * * 1-5'  # 平日UTC 0:00 = JST 9:00
  workflow_dispatch:        # 手動実行用

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - run: npm ci
      - run: node src/index.js
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
      - name: Commit data.json
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data.json
          git diff --cached --quiet || git commit -m "Update data.json"
          git push
```

---

## シークレット設定

GitHub リポジトリの Settings > Secrets and variables > Actions に登録:

| 名前 | 値 |
|------|-----|
| `DISCORD_WEBHOOK_URL` | Discord Webhook URL |

---

## 米国休場日 2025年

| 日付 | 祝日 |
|------|------|
| 1/1 | New Year's Day |
| 1/20 | Martin Luther King Jr. Day |
| 2/17 | Presidents Day |
| 4/18 | Good Friday |
| 5/26 | Memorial Day |
| 6/19 | Juneteenth |
| 7/4 | Independence Day |
| 9/1 | Labor Day |
| 11/27 | Thanksgiving Day |
| 12/25 | Christmas Day |

※ 7/3, 11/28, 12/24 は短縮取引日（1:00 PM ET終了）

---

## GASからの移行メリット

| 観点 | GAS | GitHub Actions + Node.js |
|------|-----|--------------------------|
| コード共有 | △ 1つのGoogleアカウントに紐づく | ◎ リポジトリで共有 |
| 編集権限 | △ Googleアカウント共有が必要 | ◎ Collaborator追加で簡単 |
| レビュー | × なし | ◎ Pull Request |
| 変更履歴 | △ 見づらい | ◎ Git履歴 |
| ローカル実行 | × 不可 | ◎ 誰でもテスト可能 |
| シークレット管理 | △ コード内に直書き | ◎ GitHub Secrets |
| ライブラリ | △ 限定的 | ◎ npm使える |
| デバッグ | △ やりにくい | ◎ ローカル実行可 |
| コスト | 無料 | 無料 |
